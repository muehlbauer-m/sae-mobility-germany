#### Generate FH Results Tables for Manuscript ####
# Created: 2026-01-23
# Purpose: Generate tbl_df_FH.tex and tbl_df_RV.tex for manuscript
# Replaces hardcoded tables with actual multimodal FH model results

rm(list = ls())
if (!require("pacman")) install.packages("pacman")
pacman::p_load(tidyverse)

# Data path
data_path <- "./data"
output_dir <- "./manuscript"

#### Load Data ####

# Load FH model
fh_model <- readRDS(file.path(data_path, "output/models/fh_model_final.rds"))

# Load direct estimates for comparison
df_direct <- readRDS(file.path(data_path, "output/direct/df_HTH_perskm_analytical.rds"))

# Extract FH estimates
df_fh <- data.frame(
  ags5_hvm = fh_model$ind$Domain,
  FH = fh_model$ind$FH,
  Direct = fh_model$ind$Direct
)

# Extract MSE
df_mse <- data.frame(
  ags5_hvm = fh_model$MSE$Domain,
  MSE_FH = fh_model$MSE$FH
)

# Extract gamma (shrinkage factor)
df_gamma <- data.frame(
  ags5_hvm = fh_model$model$gamma$Domain,
  Gamma = fh_model$model$gamma$Gamma
)

# Merge and calculate metrics
df_fh <- df_fh %>%
  left_join(df_mse, by = "ags5_hvm") %>%
  left_join(df_gamma, by = "ags5_hvm") %>%
  mutate(
    ags5 = sub("_.*", "", ags5_hvm),
    hvm_label = sub(".*_", "", ags5_hvm),
    CV_FH = sqrt(MSE_FH) / FH
  )

# Merge with direct estimates for efficiency gain calculation
df_comparison <- df_direct %>%
  select(ags5_hvm, perskm_hth, var_hth) %>%
  left_join(df_fh %>% select(ags5_hvm, FH, MSE_FH, CV_FH, hvm_label), by = "ags5_hvm") %>%
  mutate(
    CV_HTH = sqrt(var_hth) / perskm_hth,
    # Efficiency gain (RV): relative variance reduction
    RV = (CV_HTH - CV_FH) / CV_HTH
  )

cat("=== Data loaded successfully ===\n")
cat("Total domains:", nrow(df_fh), "\n")
cat("Districts:", n_distinct(df_fh$ags5), "\n\n")

#### Table 1: FH Estimates Summary by Mode ####

# Calculate summary statistics for FH estimates
summary_fh <- df_fh %>%
  group_by(hvm_label) %>%
  summarise(
    Min_FH = min(FH, na.rm = TRUE),
    Q1_FH = quantile(FH, 0.25, na.rm = TRUE),
    Median_FH = median(FH, na.rm = TRUE),
    Mean_FH = mean(FH, na.rm = TRUE),
    Q3_FH = quantile(FH, 0.75, na.rm = TRUE),
    Max_FH = max(FH, na.rm = TRUE),
    Min_CV = min(CV_FH, na.rm = TRUE),
    Q1_CV = quantile(CV_FH, 0.25, na.rm = TRUE),
    Median_CV = median(CV_FH, na.rm = TRUE),
    Mean_CV = mean(CV_FH, na.rm = TRUE),
    Q3_CV = quantile(CV_FH, 0.75, na.rm = TRUE),
    Max_CV = max(CV_FH, na.rm = TRUE),
    Min_Gamma = min(Gamma, na.rm = TRUE),
    Q1_Gamma = quantile(Gamma, 0.25, na.rm = TRUE),
    Median_Gamma = median(Gamma, na.rm = TRUE),
    Mean_Gamma = mean(Gamma, na.rm = TRUE),
    Q3_Gamma = quantile(Gamma, 0.75, na.rm = TRUE),
    Max_Gamma = max(Gamma, na.rm = TRUE),
    n_domains = n(),
    .groups = "drop"
  )

cat("=== FH Summary Statistics by Mode ===\n")
print(summary_fh)

# Prepare table data - use plain English labels (UTF-8 German characters cause LaTeX issues)
tbl_fh <- summary_fh %>%
  mutate(
    Mode = case_when(
      hvm_label == "fuss" ~ "Walking",
      hvm_label == "fahrrad" ~ "Cycling",
      hvm_label == "miv" ~ "Car",
      hvm_label == "oepv" ~ "Public Transit"
    )
  )

# Format numeric values
format_val <- function(x, digits = 2) {
  sprintf(paste0("%.", digits, "f"), x)
}

#### Write tbl_df_FH.tex ####

latex_fh <- c(
  "% LaTeX table generated by R/plotting/generate_fh_results_table.r",
  paste0("% Generated: ", Sys.time()),
  "\\begin{table}[ht]",
  "\\centering",
  "\\begin{tabularx}{\\textwidth}{lXXXXXX}",
  "\\hline",
  "\\multicolumn{7}{c}{\\textbf{Panel A: FH EBLUP Estimates (km/day)}} \\\\",
  "\\hline",
  "\\textbf{Mode} & \\textbf{Min.} & \\textbf{1st Qu.} & \\textbf{Median} & \\textbf{Mean} & \\textbf{3rd Qu.} & \\textbf{Max.} \\\\"
)

# Add FH estimate rows
for (i in 1:nrow(tbl_fh)) {
  latex_fh <- c(latex_fh,
    paste0(tbl_fh$Mode[i], " & ",
           format_val(tbl_fh$Min_FH[i]), " & ",
           format_val(tbl_fh$Q1_FH[i]), " & ",
           format_val(tbl_fh$Median_FH[i]), " & ",
           format_val(tbl_fh$Mean_FH[i]), " & ",
           format_val(tbl_fh$Q3_FH[i]), " & ",
           format_val(tbl_fh$Max_FH[i]), " \\\\"))
}

latex_fh <- c(latex_fh,
  "\\hline",
  "\\multicolumn{7}{c}{\\textbf{Panel B: Coefficient of Variation}} \\\\",
  "\\hline",
  "\\textbf{Mode} & \\textbf{Min.} & \\textbf{1st Qu.} & \\textbf{Median} & \\textbf{Mean} & \\textbf{3rd Qu.} & \\textbf{Max.} \\\\"
)

# Add CV rows
for (i in 1:nrow(tbl_fh)) {
  latex_fh <- c(latex_fh,
    paste0(tbl_fh$Mode[i], " & ",
           format_val(tbl_fh$Min_CV[i]), " & ",
           format_val(tbl_fh$Q1_CV[i]), " & ",
           format_val(tbl_fh$Median_CV[i]), " & ",
           format_val(tbl_fh$Mean_CV[i]), " & ",
           format_val(tbl_fh$Q3_CV[i]), " & ",
           format_val(tbl_fh$Max_CV[i]), " \\\\"))
}

latex_fh <- c(latex_fh,
  "\\hline",
  "\\multicolumn{7}{c}{\\textbf{Panel C: Shrinkage Factor ($\\hat{\\gamma}_d$)}} \\\\",
  "\\hline",
  "\\textbf{Mode} & \\textbf{Min.} & \\textbf{1st Qu.} & \\textbf{Median} & \\textbf{Mean} & \\textbf{3rd Qu.} & \\textbf{Max.} \\\\"
)

# Add Gamma rows
for (i in 1:nrow(tbl_fh)) {
  latex_fh <- c(latex_fh,
    paste0(tbl_fh$Mode[i], " & ",
           format_val(tbl_fh$Min_Gamma[i]), " & ",
           format_val(tbl_fh$Q1_Gamma[i]), " & ",
           format_val(tbl_fh$Median_Gamma[i]), " & ",
           format_val(tbl_fh$Mean_Gamma[i]), " & ",
           format_val(tbl_fh$Q3_Gamma[i]), " & ",
           format_val(tbl_fh$Max_Gamma[i]), " \\\\"))
}

latex_fh <- c(latex_fh,
  "\\hline",
  "\\hline",
  "\\end{tabularx}",
  paste0("\\caption{Summary statistics of multimodal \\ac{FH} \\ac{EBLUP} estimates. ",
         "Panel A shows bias-corrected back-transformed estimates (km/day) by transport mode. ",
         "Panel B shows the coefficient of variation. ",
         "Panel C shows the shrinkage factor $\\hat{\\gamma}_d = \\hat{\\sigma}^{2}_{u} / (\\hat{\\sigma}^{2}_{u} + \\sigma^{2}_{d})$, ",
         "where higher values indicate more weight on the direct estimate. ",
         "Total domains: ", nrow(df_fh), " (", n_distinct(df_fh$ags5), " districts $\\times$ 4 modes, after exclusions).}"),
  "\\label{tbl:df_FH}",
  "\\end{table}"
)

writeLines(latex_fh, file.path(output_dir, "tbl_df_FH.tex"))
cat("\n=== tbl_df_FH.tex saved ===\n")

#### Table 2: Efficiency Gain (RV) Summary by Mode ####

summary_rv <- df_comparison %>%
  filter(!is.na(RV)) %>%
  group_by(hvm_label) %>%
  summarise(
    Min_RV = min(RV, na.rm = TRUE),
    Q1_RV = quantile(RV, 0.25, na.rm = TRUE),
    Median_RV = median(RV, na.rm = TRUE),
    Mean_RV = mean(RV, na.rm = TRUE),
    Q3_RV = quantile(RV, 0.75, na.rm = TRUE),
    Max_RV = max(RV, na.rm = TRUE),
    n_negative = sum(RV < 0, na.rm = TRUE),
    n_domains = n(),
    .groups = "drop"
  )

cat("\n=== Efficiency Gain (RV) Summary by Mode ===\n")
print(summary_rv)

# Prepare table data - use plain English labels (UTF-8 German characters cause LaTeX issues)
tbl_rv <- summary_rv %>%
  mutate(
    Mode = case_when(
      hvm_label == "fuss" ~ "Walking",
      hvm_label == "fahrrad" ~ "Cycling",
      hvm_label == "miv" ~ "Car",
      hvm_label == "oepv" ~ "Public Transit"
    )
  )

#### Write tbl_df_RV.tex ####

latex_rv <- c(
  "% LaTeX table generated by R/plotting/generate_fh_results_table.r",
  paste0("% Generated: ", Sys.time()),
  "\\begin{table}[ht]",
  "\\centering",
  "\\begin{tabularx}{\\textwidth}{lXXXXXX}",
  "\\hline",
  "\\textbf{Mode} & \\textbf{Min.} & \\textbf{1st Qu.} & \\textbf{Median} & \\textbf{Mean} & \\textbf{3rd Qu.} & \\textbf{Max.} \\\\",
  "\\hline",
  "\\hline"
)

# Add RV rows
for (i in 1:nrow(tbl_rv)) {
  latex_rv <- c(latex_rv,
    paste0(tbl_rv$Mode[i], " & ",
           format_val(tbl_rv$Min_RV[i]), " & ",
           format_val(tbl_rv$Q1_RV[i]), " & ",
           format_val(tbl_rv$Median_RV[i]), " & ",
           format_val(tbl_rv$Mean_RV[i]), " & ",
           format_val(tbl_rv$Q3_RV[i]), " & ",
           format_val(tbl_rv$Max_RV[i]), " \\\\"))
}

latex_rv <- c(latex_rv,
  "\\hline",
  "\\hline",
  "\\end{tabularx}",
  paste0("\\caption{Summary statistics of the relative variability reduction $RV_d = (CV^{HJ}_d - CV^{FH}_d) / CV^{HJ}_d$ by transport mode. ",
         "Positive values indicate precision improvement from the \\ac{FH} model. ",
         "Domains with negative RV: ", sum(summary_rv$n_negative), " out of ", sum(summary_rv$n_domains), ".}"),
  "\\label{tbl:df_RV}",
  "\\end{table}"
)

writeLines(latex_rv, file.path(output_dir, "tbl_df_RV.tex"))
cat("\n=== tbl_df_RV.tex saved ===\n")

#### Overall Summary ####

cat("\n=== CV > 20% Threshold Statistics ===\n")

# Direct estimates CV > 20%
n_direct_above <- sum(df_comparison$CV_HTH > 0.20, na.rm = TRUE)
n_direct_total <- sum(!is.na(df_comparison$CV_HTH))
pct_direct_above <- 100 * n_direct_above / n_direct_total

cat("DIRECT (HJ) domains with CV > 20%:",
    n_direct_above, "of", n_direct_total,
    sprintf("(%.1f%%)", pct_direct_above), "\n")

# FH estimates CV > 20%
n_fh_above <- sum(df_fh$CV_FH > 0.20, na.rm = TRUE)
n_fh_total <- nrow(df_fh)
pct_fh_above <- 100 * n_fh_above / n_fh_total

cat("FH domains with CV > 20%:",
    n_fh_above, "of", n_fh_total,
    sprintf("(%.1f%%)", pct_fh_above), "\n")

cat("\n=== Efficiency Statistics ===\n")
cat("Domains with negative RV (FH worse than HTH):",
    sum(df_comparison$RV < 0, na.rm = TRUE), "of", sum(!is.na(df_comparison$RV)), "\n")

cat("\n=== Done! ===\n")
cat("Tables saved:\n")
cat("  - tbl_df_FH.tex (FH estimates summary)\n")
cat("  - tbl_df_RV.tex (Efficiency gain summary)\n")
